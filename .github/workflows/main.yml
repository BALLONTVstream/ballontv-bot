name: BALLONTV_ADVANCED_ENGINE
on:
  workflow_dispatch:
    inputs:
      source_url: { required: true }
      server_url: { required: true }
      stream_key: { required: true }

jobs:
  streaming:
    runs-on: ubuntu-latest
    steps:
      - name: Install Tools
        run: |
          sudo apt update && sudo apt install -y ffmpeg
          sudo curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -o /usr/local/bin/yt-dlp
          sudo chmod a+rx /usr/local/bin/yt-dlp

      - name: Execution
        run: |
          # دالة البث مع إعادة التشغيل التلقائي
          run_stream() {
            ffmpeg -reconnect 1 -reconnect_at_eof 1 -reconnect_streamed 1 -reconnect_delay_max 5 \
            -re -i "${{ github.event.inputs.source_url }}" \
            -vf "drawtext=text='BALLONTV':x=w-tw-20:y=20:fontsize=35:fontcolor=white:box=1:boxcolor=black@0.4" \
            -c:v libx264 -preset veryfast -b:v 2500k -maxrate 3000k -bufsize 6000k \
            -pix_fmt yuv420p -g 60 -c:a aac -b:a 128k -f flv \
            "${{ github.event.inputs.server_url }}${{ github.event.inputs.stream_key }}"
          }

          until run_stream; do
            echo "إعادة المحاولة بعد 15 ثانية..."
            sleep 15
          done
